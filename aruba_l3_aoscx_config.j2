{# ------------------------------------------------------------------------------
  NetBox â†’ ArubaOS-CX 10.14 L3 Switch Template (minimal-filter, whitespace-trimmed)
  - No regex/split/append/do; avoids warnings that rely on loop-scoped vars.
  - Supports either:
      users: [{name: "...", ciphertext: "..."}]
    OR
      User (iterable of usernames) + User.admin.password (list; we take first)
------------------------------------------------------------------------------ #}

hostname {{device.name}}
{%- for name in User %}
user {{ name }} group administrators password ciphertext {%- endfor %} {% for password in User.admin.password %}{{password}}{%- endfor %}
aruba-central
  {{ aruba_central.status }}
  location-override {{ aruba_central.location_override_location }} vrf {{ aruba_central.location_override_vrf }}
  exit
ssh server vrf default
clock timezone {{ device.site.time_zone }}
ntp enable
{%- for server in ntp_server %}
no ntp server pool.ntp.org
ntp server {{ server }} minpoll 4 maxpoll 4 iburst {%- endfor %}
{%- for vl in device.site.vlans.all() %} 
{%- if vl.status != "reserved" %}
vlan {{vl.vid }}
  name {{vl.name}}{%- endif %}{% endfor %}
exit

ip routing

{# --- VRFs (optional; skip "default") --- #}
{%- for v in vrfs|default([]) -%}
  {%- if v|lower != "default" -%}
vrf {{ v }}
  {%- endif -%}
{%- endfor %}

{# --- Spanning Tree (optional) --- #}
spanning-tree
{%- if spanning_tree is defined and spanning_tree.config_name -%}
spanning-tree config-name {{ spanning_tree.config_name }}
{%- endif -%}
{%- if spanning_tree is defined and spanning_tree.config_revision -%}
spanning-tree config-revision {{ spanning_tree.config_revision }}
{%- endif %}

{# --- Interfaces --- #}
{%- for interface in device.interfaces.all() %}

{# SVI detection without split/regex: expect "vlan <vid>" #}
{%- set name_l = interface.name|lower -%}
{%- set is_svi = (name_l[:5] == 'vlan ' and name_l|length > 5) -%}
{%- if is_svi -%}
  {%- set svi_vid = name_l[5:]|int -%}
{%- else -%}
  {%- set svi_vid = none -%}
{%- endif -%}

{%- if not interface.mgmt_only -%}
  {# ----- SVI path ----- #}
  {%- if is_svi -%}
interface vlan {{ svi_vid }}
    {%- if interface.enabled -%}
  description {{ interface.description|default("SVI-" ~ svi_vid) }}
  no shutdown
      {%- for ip in interface.ip_addresses.all() -%}
        {%- if ip.family == 4 -%}
  ip address {{ ip.address }}
        {%- endif -%}
      {%- endfor -%}
      {# DHCP relay helpers (optional) #}
      {%- if dhcp_relays is defined and dhcp_relays.get(svi_vid) -%}
        {%- for helper in dhcp_relays.get(svi_vid) -%}
  ip helper-address {{ helper }}
        {%- endfor -%}
      {%- endif -%}
      {# OSPF per-interface (optional) #}
      {%- if ospf is defined and ospf.enabled and ospf.interfaces is defined -%}
        {%- for oi in ospf.interfaces -%}
          {%- if oi.name|lower == ('vlan ' ~ svi_vid)|lower -%}
  ip ospf area {{ oi.area }}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- else -%}
  shutdown
    {%- endif -%}

  {# ----- Physical/LAG path ----- #}
  {%- else -%}
interface {{ interface.name }}
    {%- if not interface.enabled -%}
  no description
  shutdown
    {%- else -%}
  description {{ interface.description|default("")|truncate(240) }}
  no shutdown

      {# Routed port if mode==routed OR interface has IPv4(s) #}
      {%- set treat_routed = (interface.mode is defined and interface.mode == "routed") -%}
      {%- if not treat_routed -%}
        {%- for ip in interface.ip_addresses.all() -%}
          {%- if ip.family == 4 -%}
            {%- set treat_routed = true -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- if treat_routed -%}
  routing
        {%- for ip in interface.ip_addresses.all() -%}
          {%- if ip.family == 4 -%}
  ip address {{ ip.address }}
          {%- endif -%}
        {%- endfor -%}
        {# OSPF per-interface (optional) #}
        {%- if ospf is defined and ospf.enabled and ospf.interfaces is defined -%}
          {%- for oi in ospf.interfaces -%}
            {%- if oi.name|lower == interface.name|lower -%}
  ip ospf area {{ oi.area }}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- else -%}
        {# L2 modes #}
        {%- if interface.mode == "access" and interface.untagged_vlan is not none -%}
  vlan access {{ interface.untagged_vlan.vid }}
        {%- elif interface.mode == "tagged" -%}
          {%- if interface.untagged_vlan is not none -%}
  vlan trunk native {{ interface.untagged_vlan.vid }}
          {%- endif -%}
          {%- set tvs = interface.tagged_vlans.all() -%}
          {%- if tvs|length > 0 -%}
  vlan trunk allowed {%- for tv in tvs -%}{{ tv.vid }}{%- if not loop.last -%},{%- endif -%}{%- endfor %}
          {%- endif -%}
          {%- if 'lag' in interface.name|lower -%}
  lacp mode active
          {%- endif -%}
        {%- elif interface.mode and 'tagged-all' in interface.mode|lower -%}
  vlan trunk native {{ interface.untagged_vlan.vid if interface.untagged_vlan is not none else 799 }}
  vlan trunk allowed all
          {%- if 'lag' in interface.name|lower -%}
  lacp mode active
          {%- endif -%}
        {%- endif -%}
        {# LAG membership (no regex) #}
        {%- if interface.lag is not none and interface.lag.name -%}
          {%- set lagnum = interface.lag.name|lower|replace('lag','')|replace('ae','')|replace('port-channel','')|replace(' ','') -%}
          {%- if lagnum -%}
  lag {{ lagnum }}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}

{%- else -%}
  {# ----- mgmt_only interface ----- #}
interface {{ interface.name }}
  {%- if interface.enabled -%}
  description {{ interface.description|default("MGMT") }}
  no shutdown
    {%- for ip in interface.ip_addresses.all() -%}
      {%- if ip.family == 4 -%}
  ip address {{ ip.address }}
      {%- endif -%}
    {%- endfor -%}
  {%- else -%}
  shutdown
  {%- endif -%}
{%- endif %}

{%- endfor %}

{# --- DNS & domain --- #}
{%- for server in name_server|default([]) -%}
ip dns server-address {{ server }}
{%- endfor -%}
{%- for d in domain_name|default([]) -%}
ip domain-name {{ d }}
{%- endfor %}

{# --- SNMP --- #}
snmp-server vrf {{ snmp_vrf|default('default') }}
snmp-server system-location {{ device.rack|default('') }}
snmp-server system-contact {{ snmp_system_contact|default('') }}
snmp-server system-description {{ device.description|default('') }}
snmp-server community {{ snmp_community|default('public') }}

{# --- Static routes --- #}
{%- if ip_routes is defined and ip_routes -%}
  {%- if ip_routes is string -%}
ip route {{ ip_routes }}
  {%- else -%}
    {%- for r in ip_routes -%}
      {%- set vrf_name = r.vrf|default('default') -%}
      {%- if vrf_name|lower == 'default' -%}
ip route {{ r.prefix }} {{ r.next_hop }}{%- if r.distance is defined %} {{ r.distance }}{%- endif %}
      {%- else -%}
ip route vrf {{ vrf_name }} {{ r.prefix }} {{ r.next_hop }}{%- if r.distance is defined %} {{ r.distance }}{%- endif %}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- endif %}

{# --- OSPF global (optional) --- #}
{%- if ospf is defined and ospf.enabled and ospf.router_id is defined -%}
  {%- set ospf_vrf = ospf.vrf|default('default') -%}
  {%- if ospf_vrf|lower == 'default' -%}
router ospf
  router-id {{ ospf.router_id }}
  {%- else -%}
router ospf vrf {{ ospf_vrf }}
  router-id {{ ospf.router_id }}
  {%- endif -%}
{%- endif %}
